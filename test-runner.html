<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Test...</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* --- Root Variables & Dark Mode --- */
        :root{--primary:#007bff;--primary-light:#52a4ff;--primary-dark:#0056b3;--secondary:#6c757d;--accent:#ffc107;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--gray:#6c757d;--light-gray:#dfe6e9;--card-bg:#fff;--body-bg:#f4f7fe;--header-bg:linear-gradient(135deg,var(--primary),var(--primary-dark));--footer-bg:#fff;--box-shadow:0 4px 20px rgba(0,0,0,.08);--transition:all .3s cubic-bezier(.25,.8,.25,1)}
        body.dark-mode{--primary:#3498db; --light:#2c3e50;--dark:#ecf0f1;--gray:#95a5a6;--light-gray:#34495e;--card-bg:#1e272e;--body-bg:#141d26;--footer-bg:#1e272e;--box-shadow:0 4px 20px rgba(0,0,0,.3);--accent:#f1c40f}
                body.dark-mode .header {
            background: linear-gradient(135deg, var(--primary), #2980b9);
                }
                
                body.dark-mode .nav-btn {
            border-color: var(--primary);
            color: var(--primary);
                }
        body.dark-mode .option-input:checked+.option-label{background:rgba(0,123,255,.15)}
        body.dark-mode .solution-container, body.dark-mode .topic-analysis-container{background:rgba(0,123,255,.1)}
        body.dark-mode .review-mode .option-label.correct-answer{background:rgba(40,167,69,.1)}
        body.dark-mode .review-mode .option-input:checked+.option-label.incorrect{background:rgba(220,53,69,.1)}
        body.dark-mode .results-card{background:var(--card-bg)}
        body.dark-mode #user-details-modal .user-details-card .form-control{background-color:#34495e;color:#ecf0f1;border-color:#566573}
        body.dark-mode #user-details-modal .user-details-card .form-control::placeholder{color:#95a5a6}
        
        /* --- Global & Body Styles --- */
        *{-webkit-tap-highlight-color:transparent}
        body{background-color:var(--body-bg);font-family:Poppins,'Noto Sans Devanagari',sans-serif;color:var(--dark);line-height:1.6;overflow-x:hidden;transition:background-color .3s,color .3s}
        body:not(.welcome-mode){padding-top:60px;padding-bottom:80px}

        /* --- Welcome Screen --- */
        #welcome-screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1200;display:flex;align-items:center;justify-content:center;padding:16px;overflow:hidden;background-size:cover;background-position:center center}
        #welcome-screen::before{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;z-index:-1;background:linear-gradient(rgba(29,36,47,.7),rgba(29,36,47,.7));backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px)}
        .welcome-card{background:rgba(255,255,255,.1);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:32px;width:100%;max-width:500px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:fadeInUp .8s cubic-bezier(.25,.8,.25,1) forwards}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .welcome-icon{font-size:3rem;color:#fff;margin-bottom:16px;text-shadow:0 2px 10px rgba(0,0,0,.2)}
        .welcome-card h3{font-weight:700;font-size:1.8rem;color:#fff;margin-bottom:8px;text-shadow:0 1px 5px rgba(0,0,0,.2)}
        .welcome-branding a{color:rgba(255,255,255,.8);font-size:1.1rem;font-weight:500;text-decoration:none;margin-bottom:32px;display:inline-block;transition:var(--transition)}
        .welcome-branding a:hover{color:#fff}
        .welcome-branding .kundan-font{font-weight:600;color:#ff0}
        .welcome-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:32px}
        .stat-item{background:rgba(255,255,255,.1);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.2)}
        .stat-item .icon{font-size:1.5rem;color:#fff;margin-bottom:8px}
        .stat-item .value{font-size:1.4rem;font-weight:600;color:#fff}
        .stat-item .label{font-size:.85rem;color:rgba(255,255,255,.7);font-weight:500}
        #start-test-btn{width:100%;padding:14px;font-size:1.1rem;font-weight:600;border-radius:12px;animation:pulse 2s infinite}
        @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,.4)}70%{transform:scale(1.02);box-shadow:0 0 0 10px rgba(0,123,255,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,0)}}
        
        /* --- Main Test UI: Header & Footer --- */
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--header-bg);color:#fff;display:flex;align-items:center;padding:0 16px;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .header-content{display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px}
        .header-brand{display:flex;align-items:center;font-weight:600;color:#fff;text-decoration:none;flex:1 1 0;min-width:0}
        .header-brand i{margin-right:8px;font-size:1.2rem;flex-shrink:0}
        .header-brand span { white-space: normal; line-height: 1.2; font-size: 0.85rem; }
        .header-controls{display:flex;align-items:center;gap:8px;flex-shrink:0}
        .control-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition);flex-shrink:0}
        .control-btn:hover{background:rgba(255,255,255,.2)}
        .submit-btn-header{height:34px;padding:0 10px;font-size:0.8rem;border-radius:17px}
        .submit-btn-header.submitted-state{padding:0;width:34px;background-color:var(--success);border-color:var(--success);cursor:default}
                @keyframes blink-animation {
            0% { background-color: var(--danger); transform: scale(1); box-shadow: 0 0 5px var(--danger); }
            50% { background-color: #ff7675; transform: scale(1.05); box-shadow: 0 0 15px #ff7675; }
            100% { background-color: var(--danger); transform: scale(1); box-shadow: 0 0 5px var(--danger); }
        }

        .submit-btn-header.blinking {
            animation: blink-animation 1.5s infinite;
            border-color: #fff;
            color: #fff;
        }                                                                                                           }
        .submit-btn-header:hover:not(.submitted-state){background:rgba(255,255,255,.25)}
        .timer-display{background:rgba(0,0,0,.2);border-radius:18px;padding:4px 10px;font-size:.8rem;font-weight:500;display:flex;align-items:center;flex-shrink:0}
        .timer-display i{margin-right:6px}
        
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:80px;background:var(--footer-bg);box-shadow:0 -2px 10px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:800;transition:background-color .3s}
        .nav-btn{height:48px;border-radius:12px;border:1px solid var(--primary);font-weight:500;display:flex;align-items:center;justify-content:center;padding:0 20px;transition:var(--transition);gap:8px;background:0 0;color:var(--primary);flex-shrink:0}
        #inline-mark-btn { height: 40px; padding: 0 8px; font-size: 0.8rem; flex-grow: 1; margin: 0 8px; border-color: var(--secondary); color: var(--secondary); max-width: 100px; }
        #inline-mark-btn.marked { border-color: var(--accent); color: var(--accent); font-weight: 600; }
        .desktop-footer{position:fixed;bottom:0;left:0;right:320px;height:40px;background:var(--dark);color:#fff;align-items:center;justify-content:center;z-index:850;display:none}
        .desktop-footer.show{display:flex}
        .desktop-footer a{color:#fff;text-decoration:none;font-weight:500}
        .desktop-footer a:hover{color:var(--accent)}
        
        /* --- Section Tabs --- */
        #section-tabs-container { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
        .section-tab { padding: 8px 16px; border-radius: 50px; background: var(--light-gray); color: var(--secondary); font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; border: none; }
                /* FOR LIGHT MODE: Bright and Punchy Orange */
        .section-tab.active {
            background: #e67919; /* Bright Orange */
            color: #fff;
            box-shadow: 0 2px 8px rgba(230, 126, 34, 0.4);
        }

        /* FOR DARK MODE: Softer, Less Saturated Orange */
        body.dark-mode .section-tab.active {
            background: #803300; /* Deeper/Duller Orange */
            color: #f0f0f0; /* Slightly off-white text for better feel */
            box-shadow: 0 2px 8px rgba(211, 84, 0, 0.2);
        }
                        
        /* --- Main Test UI: Question & Options --- */
        .main-content{padding:16px;padding-bottom: 20px;}
        .question-card,.results-card,.question-nav{background:var(--card-bg);transition:background-color .3s}
        .question-card{border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);border:1px solid transparent;overflow:hidden}
        .question-counter{font-size:.9rem;color:var(--gray);text-align:center;margin-bottom:16px;font-weight:500}
        .question-text{font-size:1.1rem;line-height:1.6;margin-bottom:20px;color:var(--dark);overflow-wrap:break-word;word-wrap:break-word}
        .question-image-container { text-align: center; margin-bottom: 20px; }
        .question-image { max-width: 100%; max-height: 250px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,.1); }
        .lang-toggle-container{display:flex;justify-content:center;margin-bottom:20px;background-color:var(--light-gray);border-radius:12px;padding:4px}
        .lang-toggle-btn{flex:1;text-align:center;padding:8px 12px;border:none;background:0 0;cursor:pointer;border-radius:10px;font-weight:500;color:var(--secondary);transition:all .3s ease}
        .lang-toggle-btn.active{background-color:var(--card-bg);color:var(--primary);box-shadow:0 2px 5px rgba(0,0,0,.1)}
        body.dark-mode .lang-toggle-btn.active{background-color:#000;color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.3)}
        
        .option-item{margin-bottom:12px;position:relative}
        .option-input{position:absolute;opacity:0;width:0;height:0}
        .option-label{display:block;padding:14px 16px;background:var(--card-bg);border:1px solid var(--light-gray);border-radius:12px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}
        .option-label:hover{border-color:var(--primary-light);transform:translateY(-2px);box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .option-input:checked+.option-label{border-color:var(--primary);box-shadow:0 0 0 1px var(--primary)}
        .option-input:checked+.option-label::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--primary)}
        .review-mode .option-label.correct-answer{border-color:var(--success);background:rgba(40,167,69,.05)}
        .review-mode .option-label.correct-answer::after{background:var(--success)}
        .review-mode .option-input:checked+.option-label.incorrect{border-color:var(--danger);background:rgba(220,53,69,.05)}
        .review-mode .option-input:checked+.option-label.incorrect::after{background:var(--danger)}
        .solution-container, .topic-analysis-container{margin-top:20px;padding:16px;border-radius:12px;border-left:3px solid var(--primary)}
        .solution-title{font-weight:600;margin-bottom:8px;color:var(--primary)}
        .time-taken-info{font-size:.8rem;color:var(--secondary);font-style:italic;margin-top:10px}
        
        /* --- Question Navigator (Sidebar) --- */
        .question-nav{position:fixed;top:60px;right:0;bottom:0;width:100%;max-width:320px;box-shadow:-5px 0 15px rgba(0,0,0,.1);transform:translateX(100%);transition:var(--transition);z-index:900;overflow-y:auto;padding:16px}
        .question-nav.show{transform:translateX(0)}
        .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .nav-title{font-weight:600;font-size:1.1rem;margin:0}
        .nav-section-title { font-weight: 600; color: var(--primary); margin-top: 16px; margin-bottom: 8px; font-size: 0.9rem; }
        .question-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:8px}
        .q-box{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;font-weight:500;border:1px solid var(--light-gray);background:var(--card-bg);transition:var(--transition)}
        .q-box.attempted{background-color:var(--primary);color:#fff;border-color:var(--primary)}
        .q-box.correct{background-color:var(--success);color:#fff;border-color:var(--success)}
        .q-box.incorrect{background-color:var(--danger);color:#fff;border-color:var(--danger)}
        .q-box.current{transform:scale(1.1); box-shadow: 0 0 10px var(--accent);}
        .q-box.unattempted{background-color:var(--gray);color:#fff;border-color:var(--gray)}
        .q-box.marked { background-color: var(--accent); color: var(--dark); border-color: var(--accent); font-weight: 600; }
        .q-box.attempted.marked { background-color: var(--primary); border: 2px solid var(--accent); }

        .nav-overlay{position:fixed;top:60px;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:890;opacity:0;pointer-events:none;transition:var(--transition)}
        .nav-overlay.show{opacity:1;pointer-events:all}
        
        /* --- Modals & Other Components --- */
        .results-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;pointer-events:none;transition:var(--transition);padding:16px; overflow-y: auto;}
        .results-modal.show{opacity:1;pointer-events:all}
        .results-card{border-radius:20px;width:100%;max-width:500px;padding:20px;text-align:center; margin: auto;}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1rem;margin-bottom:1.5rem}
        .stat-card{color:#fff;padding:1rem;border-radius:12px}
        .stat-value{font-size:2rem;font-weight:600}
        .stat-label{font-size:.9rem}
        .results-footer{display:flex;justify-content:center;gap:16px}
        #user-details-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1250;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s ease-in-out}
        #user-details-modal.show{opacity:1;pointer-events:all}
        .user-details-card{background:var(--card-bg);border-radius:20px;padding:32px;width:100%;max-width:450px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.3);transform:translateY(20px);opacity:0;animation:fadeInScale .3s forwards}
        @keyframes fadeInScale{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
        .user-details-card h4{font-weight:600;margin-bottom:24px;color:var(--dark)}
        .user-details-card .form-group{margin-bottom:15px;text-align:left}
        .user-details-card .form-control{width:100%;padding:12px;border:1px solid var(--light-gray);border-radius:8px;font-size:1rem;color:var(--dark);background-color:var(--body-bg);transition:border-color .3s,box-shadow .3s}
        .user-details-card .form-control:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}
        .user-details-card .btn-proceed{width:100%;padding:12px;font-size:1rem;font-weight:500;border-radius:10px;margin-top:20px}
        
        #floating-pdf-btn{position:fixed;bottom:100px;right:20px;width:60px;height:60px;border-radius:50%;background-color:var(--success);color:#fff;border:none;box-shadow:0 4px 15px rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;font-size:1.5rem;z-index:1050;transition:var(--transition)}
        #floating-pdf-btn:hover{transform:scale(1.1);background-color:#218838}
        
        @media (min-width:992px){.main-content{margin-right:320px}.question-nav{transform:translateX(0);bottom:40px}.bottom-nav{display:none}#floating-pdf-btn{right:340px;bottom:60px}}
        @media (max-width:991.98px){.desktop-footer{display:none!important}.question-nav{bottom:80px}}
    </style>
</head>
<body class="welcome-mode">
    
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="welcome-card">
            <div class="welcome-icon"><i class="fas fa-brain"></i></div>
            <h3 id="welcome-title">Loading Test...</h3>
            <div class="welcome-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">By: <span class="kundan-font">𝕂𝕦𝕟𝕕𝕒𝕟 𝕐𝕒𝕕𝕒𝕧 😎</span></a></div>
            <div class="welcome-stats">
                <div class="stat-item"><div class="icon"><i class="fas fa-list-ol"></i></div><div class="value" id="welcome-q-count">--</div><div class="label">Questions</div></div>
                <div class="stat-item"><div class="icon"><i class="fas fa-star"></i></div><div class="value" id="welcome-marks">--</div><div class="label">Total Marks</div></div>
                <div class="stat-item"><div class="icon"><i class="far fa-clock"></i></div><div class="value" id="welcome-time">--:--</div><div class="label">Time</div></div>
                <div class="stat-item"><div class="icon"><i class="fas fa-pen-fancy"></i></div><div class="value" style="color: var(--success);" id="welcome-marking">--</div><div class="label">Marking Scheme</div></div>
            </div>
            <div id="start-area"></div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-details-modal">
        <div class="user-details-card">
            <h4>Enter Your Details</h4>
            <div class="form-group"><input type="text" id="user-name-input" class="form-control" placeholder="Your Name" required></div>
            <div class="form-group"><input type="tel" id="user-mobile-input" class="form-control" placeholder="Mobile Number" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number"></div>
            <button class="btn btn-primary btn-proceed" onclick="proceedToTest()">Proceed to Test</button>
        </div>
    </div>

    <!-- Main Test Container -->
    <div id="test-container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="https://t.me/kundan_yadav_bot" target="_blank" class="header-brand">
                    <i class="fas fa-brain"></i>
                    <span id="header-title">Test</span>
                </a>
                <div class="header-controls">
                    <div class="timer-display"><i class="far fa-clock"></i><span id="timer-display">00:00</span></div>
                    <button id="theme-toggle-btn" class="control-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <button id="submit-btn-header" class="submit-btn-header" onclick="confirmSubmit()">Submit</button>
                    <button class="control-btn nav-toggle-btn d-lg-none" onclick="toggleNav()"><i class="fas fa-th"></i></button>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <div id="section-tabs-container"></div>
            <div class="question-counter" id="question-counter">Question 1 of --</div>
            <div id="questions-container"></div>
        </main>
        
        <!-- Question Navigator (Sidebar) -->
        <aside class="question-nav" id="question-nav">
            <div class="nav-header">
                <h3 class="nav-title">Questions</h3>
                <div class="question-stats">
                    <span class="badge bg-primary" id="attempted-count">0</span>
                    <span class="badge bg-secondary" id="total-count">--</span>
                    <button class="control-btn d-lg-none" onclick="toggleNav(false)" style="color:var(--dark); background:var(--light-gray);"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="question-palette"></div>
        </aside>
        
        <!-- Overlay -->
        <div class="nav-overlay" id="nav-overlay" onclick="toggleNav(false)"></div>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="bottom-nav d-lg-none">
            <button class="nav-btn" onclick="prevQuestion()"><i class="fas fa-chevron-left"></i> Prev</button>
            <button id="inline-mark-btn" class="nav-btn" onclick="markQuestionForReview()">
                <i class="far fa-flag"></i> Mark
            </button>
            <button class="nav-btn" onclick="nextQuestion()">Next <i class="fas fa-chevron-right"></i></button>
        </nav>
        
        <!-- Desktop Footer -->
        <footer class="desktop-footer" id="desktop-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">Contact- 𝕂𝕦𝕟𝕕𝕒𝕟 𝕐𝕒𝕕𝕒𝕧 😎</a></footer>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="results-modal">
        <div class="results-card">
            <h3>Test Results</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark))"><div class="stat-value" id="score-value">0</div><div class="stat-label">Score</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #1b9aaa)"><div class="stat-value" id="correct-value">0</div><div class="stat-label">Correct</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--danger), #e84393)"><div class="stat-value" id="incorrect-value">0</div><div class="stat-label">Incorrect</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--gray), var(--dark))"><div class="stat-value" id="unattempted-value">0</div><div class="stat-label">Unattempted</div></div>
            </div>
            <div id="topic-analysis-chart-container" style="margin-bottom: 20px;">
                <canvas id="topicAnalysisChart"></canvas>
            </div>
            <div class="results-footer"><button class="nav-btn btn btn-primary" onclick="reviewTest()"><i class="fas fa-search me-1"></i> Review</button></div>
        </div>
    </div>
    
    <!-- Floating PDF Button -->
    <button id="floating-pdf-btn" onclick="downloadPDF(this)" title="Download PDF Report"><i class="fas fa-file-pdf"></i></button>

    <script>
        // --- CONFIGURATION & GLOBAL VARIABLES ---
        const BOT_TOKEN = '8338911838:AAG5qTixTQyun4ktSUufxgOf1RDL25FhIWY';
        const CHAT_ID = '-1002588189635';
        
        let userName = '', userMobile = '', testTitle = '';
        let sections = [], questions = [], totalQuestions = 0;
        let currentLang = "en", currentQuestion = 0;
        let answers = {}, submitted = false, testStarted = false;
        let totalTime = 0, timeSpent = {}, timerInterval, questionTimer, timeOnCurrentQuestion = 0;
        let markedForReview = {};
        let topicAnalysis = {};

        const backgroundImages = [ 'https://s.tfrbot.com/h/r8dCRJ', 'https://s.tfrbot.com/h/sRMf7S', 'https://s.tfrbot.com/h/Vf6F3e', 'https://s.tfrbot.com/h/BEnHxJ' ];
        
        // --- INITIALIZATION & EVENT LISTENERS ---
        window.onload = function() { 
            setRandomBackground();
            loadTest().then(() => {
                initializeTest(); 
                if (loadProgress()) return; 
                handleResize(); 
                window.addEventListener('resize', handleResize);
                history.replaceState({page: 'instructions'}, 'Instructions', '#instructions'); 
                window.addEventListener('popstate', popStateHandler); 
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    const themeIcon = document.querySelector('#theme-toggle-btn i');
                    if(themeIcon) { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); }
                }
            }).catch(error => {
                console.error("Initialization failed:", error);
                document.getElementById('welcome-title').textContent = 'Error Loading Test';
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${error.message}</p>`;
            });
        };
        const beforeUnloadHandler = (e) => { if (testStarted && !submitted) { e.preventDefault(); e.returnValue = 'Are you sure you want to leave? Your progress will be lost.'; } };
        const popStateHandler = (event) => { if (testStarted && !submitted && event.state && event.state.page === 'instructions') { const exitConfirm = confirm("Are you sure you want to exit the test? Your progress will not be saved."); if (exitConfirm) { location.reload(); } else { history.pushState({page: 'test'}, 'Test In Progress', '#test'); } } else if (event.state && event.state.page === 'test') { showTestUI(); } else { showWelcomeUI(); } };
        
        // --- UI CONTROL FUNCTIONS ---
        function showWelcomeUI(){document.getElementById('welcome-screen').style.display='flex';document.getElementById('test-container').style.display='none';document.body.classList.add('welcome-mode');document.getElementById('floating-pdf-btn').style.display='none';document.getElementById('user-details-modal').classList.remove('show')}
        function showTestUI(){document.getElementById('welcome-screen').style.display='none';document.getElementById('test-container').style.display='block';document.body.classList.remove('welcome-mode')}
        function showUserDetailsPopup(){document.getElementById('user-details-modal').classList.add('show');document.body.style.overflow='hidden';document.getElementById('user-name-input').value=localStorage.getItem('userName')||'';document.getElementById('user-mobile-input').value=localStorage.getItem('userMobile')||''}
        function toggleTheme(){const e=document.body;e.classList.toggle('dark-mode');const o=document.querySelector('#theme-toggle-btn i');e.classList.contains('dark-mode')?(localStorage.setItem('theme','dark'),o.classList.remove('fa-moon'),o.classList.add('fa-sun')):(localStorage.setItem('theme','light'),o.classList.remove('fa-sun'),o.classList.add('fa-moon'))}
        function handleResize(){const e=document.getElementById('question-nav');window.innerWidth>=992?e.classList.add('show'):e.classList.remove('show')}
        function setRandomBackground(){const e=document.getElementById('welcome-screen'),o=Math.floor(Math.random()*backgroundImages.length);e.style.backgroundImage=`url('${backgroundImages[o]}')`}

        // --- TEST DATA & SETUP ---
        async function loadTest() {
            try{
                const urlParams = new URLSearchParams(window.location.search);
                const testId = urlParams.get('test');
                if (!testId) throw new Error("No test ID provided in the URL.");
                const response = await fetch(`tests/${testId}.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Could not load data file: tests/${testId}.json`);
                const testData = await response.json();
                
                sections = testData.sections || [{ name: "General", questions: testData.questions }];
                questions = sections.flatMap(s => s.questions);

                totalQuestions = questions.length;
                totalTime = testData.time * 60;
                testTitle = testData.title;
                document.title = testTitle;
                document.getElementById('welcome-title').textContent = testTitle;
                document.getElementById('header-title').textContent = testTitle;
                document.getElementById('welcome-q-count').textContent = totalQuestions;
                const totalMarks = questions.reduce((sum, q) => sum + (q.pos_marks ?? 1), 0);
                document.getElementById('welcome-marks').textContent = totalMarks;
                const firstQuestion = questions[0] || {};
                const posMarks = firstQuestion.pos_marks ?? 1;
                const negMarks = firstQuestion.neg_marks ?? 0;
                document.getElementById('welcome-marking').innerHTML = `<span style="color: var(--success);">+${posMarks}</span> <span style="color: var(--danger); margin-left:8px;">-${negMarks}</span>`;
                document.getElementById('welcome-time').textContent = `${testData.time}:00`;
                document.getElementById('timer-display').textContent = `${testData.time.toString().padStart(2, '0')}:00`;
                document.querySelectorAll('#total-count').forEach(el => { el.textContent = totalQuestions });
                document.getElementById('start-area').innerHTML = `<button id="start-test-btn" class="btn btn-primary" onclick="showUserDetailsPopup()">Start Test</button>`;
            } catch(e) {
                console.error("Error loading test:", e);
                document.getElementById('welcome-title').textContent = "Error Loading Test";
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${e.message}</p>`;
                throw e; 
            }
        }

        function initializeTest() {
            const paletteContainer = document.getElementById('question-palette');
            const tabsContainer = document.getElementById('section-tabs-container');
            paletteContainer.innerHTML = ''; 
            tabsContainer.innerHTML = '';
            
            let questionCounter = 0;
            sections.forEach((section, sectionIndex) => {
                const tab = document.createElement('button');
                tab.className = 'section-tab';
                tab.textContent = section.name;
                tab.onclick = () => showQuestion(questions.findIndex(q => q.id === section.questions[0].id));
                tabsContainer.appendChild(tab);

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'nav-section-title';
                sectionTitle.textContent = section.name;
                paletteContainer.appendChild(sectionTitle);

                const grid = document.createElement('div');
                grid.className = 'question-grid';
                section.questions.forEach((q) => {
                    const box = document.createElement('div');
                    box.className = 'q-box';
                    box.textContent = questionCounter + 1;
                    const qIndex = questionCounter;
                    box.onclick = () => showQuestion(qIndex);
                    box.id = `box-${qIndex}`;
                    grid.appendChild(box);
                    questionCounter++;
                });
                paletteContainer.appendChild(grid);
            });
            showQuestion(0);
        }

        // --- TEST CORE LOGIC ---
        function proceedToTest() {
            userName = document.getElementById('user-name-input').value.trim();
            userMobile = document.getElementById('user-mobile-input').value.trim();
            if (!userName) { alert('Please enter your name.'); return; }
            if (!/^\d{10}$/.test(userMobile)) { alert('Please enter a valid 10-digit mobile number.'); return; }
            
            localStorage.setItem('userName', userName);
            localStorage.setItem('userMobile', userMobile);
            localStorage.removeItem('testProgress'); 
            document.body.style.overflow = '';
            document.getElementById('user-details-modal').classList.remove('show');
            
            testStarted = true;
            history.pushState({page: 'test'}, 'Test In Progress', '#test');
            showTestUI();
            startTimer();
            window.addEventListener('beforeunload', beforeUnloadHandler);
            sendToTelegramLog({ type: 'Test Started', userName: userName, userMobile: userMobile });
        }
        
        function startQuestionTimer() { if (submitted || !testStarted) return; timeOnCurrentQuestion = 0; questionTimer = setInterval(() => { timeOnCurrentQuestion++; }, 1000); }
        function stopAndRecordTime() { clearInterval(questionTimer); if (questions.length > 0 && currentQuestion < questions.length) { const qId = questions[currentQuestion].id; timeSpent[qId] = (timeSpent[qId] || 0) + timeOnCurrentQuestion; } }
        
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            stopAndRecordTime();
            currentQuestion = index;
            const question = questions[index];
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${totalQuestions}`;
            
            document.querySelectorAll('.q-box').forEach(box => box.classList.remove('current'));
            document.getElementById(`box-${index}`).classList.add('current');
            
            // Highlight active section tab
            const currentSectionIndex = sections.findIndex(s => s.questions.some(q => q.id === question.id));
            document.querySelectorAll('.section-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === currentSectionIndex);
            });
            
            updateMarkForReviewUI();

            let langToggleHTML = `<div class="lang-toggle-container"><button class="lang-toggle-btn ${currentLang === 'en' ? 'active' : ''}" onclick="toggleLanguage('en')">English</button><button class="lang-toggle-btn ${currentLang === 'hi' ? 'active' : ''}" onclick="toggleLanguage('hi')">हिंदी</button></div>`;
            let imageHTML = question.image_url ? `<div class="question-image-container"><img src="${question.image_url}" alt="Question Image" class="question-image"></div>` : '';
            let html = `<div class="question-card">${langToggleHTML}<div class="question-text"><div class="en">${question.question_en.replace(/\n/g, '<br>')}</div><div class="hi" style="display:none">${question.question_hi.replace(/\n/g, '<br>')}</div></div>${imageHTML}<div class="options" id="options-container">`;
            const options = ['a', 'b', 'c', 'd'];
            (question.options_en || []).forEach((opt_label, i) => {
                let optionClass = ''; let isUserAnswer = answers[question.id] === options[i];
                if (submitted) { if (options[i] === question.correct) optionClass += ' correct-answer'; else if (isUserAnswer) optionClass += ' incorrect'; }
                html += `<div class="option-item"><input class="option-input" type="radio" name="q${index}" id="opt-${index}-${options[i]}" value="${options[i]}" ${isUserAnswer ? 'checked' : ''} onclick="selectAnswer('${question.id}', '${options[i]}')"><label class="option-label${optionClass}" for="opt-${index}-${options[i]}"><div class="en">${question.options_en[i]}</div><div class="hi" style="display:none">${question.options_hi[i]}</div></label></div>`;
            });
            html += `</div>`;
            if (submitted) {
                const resultText = answers[question.id] ? (answers[question.id] === question.correct ? 'Correct!' : 'Incorrect!') : 'Not attempted';
                const time = timeSpent[question.id] || 0;
                const minutes = Math.floor(time / 60); const seconds = time % 60;
                html += `<div class="solution-container"><div class="solution-title">${resultText}</div><div class="solution-text"><div class="en">${question.solution_en}</div><div class="hi" style="display:none">${question.solution_hi}</div></div><div class="time-taken-info">Time Taken: ${minutes}m ${seconds}s</div></div>`;
            }
            html += `</div>`;
            
            document.getElementById('questions-container').innerHTML = html;
            applyLanguage();
            if (window.innerWidth < 992 && !submitted) toggleNav(false);
            if (submitted) document.getElementById('options-container').classList.add('review-mode');
            if (typeof MathJax !== 'undefined') MathJax.typeset();
            startQuestionTimer();
        }

        function applyLanguage() { document.querySelectorAll('.en').forEach(el => el.style.display = currentLang === 'en' ? 'block' : 'none'); document.querySelectorAll('.hi').forEach(el => el.style.display = currentLang === 'hi' ? 'block' : 'none'); }
        function selectAnswer(qId, option) { if (submitted) return; answers[qId] = option; updateProgress(); document.getElementById(`box-${questions.findIndex(q => q.id === qId)}`).classList.add('attempted'); }
        function prevQuestion() { if (currentQuestion > 0) showQuestion(currentQuestion - 1); }
        function nextQuestion() { if (currentQuestion < questions.length - 1) showQuestion(currentQuestion + 1); }
        function toggleLanguage(lang) { if (currentLang !== lang) { currentLang = lang; showQuestion(currentQuestion); } }
        function toggleNav(show) { const nav = document.getElementById('question-nav'); const overlay = document.getElementById('nav-overlay'); if (show === undefined) show = !nav.classList.contains('show'); nav.classList.toggle('show', show); overlay.classList.toggle('show', show); if (window.innerWidth < 992) document.body.style.overflow = show ? 'hidden' : ''; }
        function updateProgress() { document.getElementById('attempted-count').textContent = Object.keys(answers).length; }

                function startTimer() {
            let timeLeft = totalTime;
            const timerDisplay = document.getElementById('timer-display');
            const submitBtn = document.getElementById('submit-btn-header'); // Get the submit button

            timerDisplay.textContent = `${Math.floor(timeLeft / 60).toString().padStart(2, '0')}:${(timeLeft % 60).toString().padStart(2, '0')}`;

            timerInterval = setInterval(() => {
                if (timeLeft <= 0 || submitted) {
                    clearInterval(timerInterval);
                    if (submitBtn) submitBtn.classList.remove('blinking'); // Stop blinking on submit
                    if (!submitted) submitTest();
                    return;
                }
                timeLeft--;

                // --- BLINKING LOGIC ---
                // Start blinking when 30 seconds are left
                if (timeLeft === 30 && !submitted) {
                    if (submitBtn) submitBtn.classList.add('blinking');
                }
                // --- END BLINKING LOGIC ---

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            setInterval(saveProgress, 5000); 
                }

        // --- Mark for Review Logic ---
        function markQuestionForReview() {
            if (submitted) return;
            const qId = questions[currentQuestion].id;
            markedForReview[qId] = !markedForReview[qId];
            updateMarkForReviewUI();
        }
        function updateMarkForReviewUI() {
            if (submitted) return;
            const qId = questions[currentQuestion].id;
            const isMarked = markedForReview[qId];
            const box = document.getElementById(`box-${currentQuestion}`);
            
            const btn = document.getElementById('inline-mark-btn');
            if(btn) {
                const icon = btn.querySelector('i');
                if (isMarked) { btn.classList.add('marked'); icon.className = 'fas fa-flag'; } 
                else { btn.classList.remove('marked'); icon.className = 'far fa-flag'; }
            }
            if (box) { box.classList.toggle('marked', isMarked); }
        }
        
        // --- SUBMISSION & RESULTS ---
        function confirmSubmit(){if(submitted)return;stopAndRecordTime();const e=Object.keys(answers).length;const t=document.createElement("div");t.className="results-modal show",t.innerHTML=`<div class="results-card" style="margin: auto;"><h4 class="mb-3">Confirm Submission</h4><p class="text-secondary mb-4">You have attempted ${e} of ${totalQuestions} questions.<br>Are you sure you want to submit?</p><div class="d-flex justify-content-center gap-2"><button onclick="startQuestionTimer(); this.closest('.results-modal').remove()" class="btn btn-outline-secondary">Cancel</button><button onclick="submitTest(); this.closest('.results-modal').remove()" class="btn btn-primary">Submit Test</button></div></div>`,document.body.appendChild(t)}
        
        function submitTest() {
                        document.getElementById('submit-btn-header')?.classList.remove('blinking');
            if (submitted) return; 
            localStorage.removeItem('testProgress');
            submitted = true; 
            clearInterval(timerInterval);
            stopAndRecordTime();
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            
            let score = 0, correctCount = 0, incorrectCount = 0;
            topicAnalysis = {};

            questions.forEach((q, index) => {
                const box = document.getElementById(`box-${index}`);
                box.classList.remove('attempted', 'marked', 'current');
                
                const pos_marks = q.pos_marks ?? 1;
                const neg_marks = q.neg_marks ?? 0;
                const topic = q.topic || "General";
                if (!topicAnalysis[topic]) {
                    topicAnalysis[topic] = { correct: 0, incorrect: 0, total: 0 };
                }
                topicAnalysis[topic].total++;
                
                if (!answers[q.id]) { 
                    box.classList.add('unattempted'); 
                } else if (answers[q.id] === q.correct) { 
                    score += pos_marks; 
                    correctCount++; 
                    box.classList.add('correct');
                    topicAnalysis[topic].correct++;
                } else { 
                    score -= neg_marks; 
                    incorrectCount++; 
                    box.classList.add('incorrect'); 
                    topicAnalysis[topic].incorrect++;
                }
            });
            const unattemptedCount = totalQuestions - (correctCount + incorrectCount);
            
            // Save result to history
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');
            history.push({ testTitle, score: score.toFixed(2), date: new Date().toISOString() });
            localStorage.setItem('testHistory', JSON.stringify(history));

            document.getElementById('score-value').textContent = score.toFixed(2);
            document.getElementById('correct-value').textContent = correctCount;
            document.getElementById('incorrect-value').textContent = incorrectCount;
            document.getElementById('unattempted-value').textContent = unattemptedCount;
            
            renderTopicAnalysisChart();
            document.getElementById('results-modal').classList.add('show');
            
            const submitBtn = document.getElementById('submit-btn-header'); 
            if(submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-check"></i>'; submitBtn.classList.add('submitted-state'); }
            
            sendToTelegramLog({ type: 'Test Submitted', userName: userName, userMobile: userMobile, score: score.toFixed(2), correct: correctCount, incorrect: incorrectCount, unattempted: unattemptedCount });
            showQuestion(currentQuestion);
        }

        function renderTopicAnalysisChart() {
            const ctx = document.getElementById('topicAnalysisChart').getContext('2d');
            const labels = Object.keys(topicAnalysis);
            const data = labels.map(label => {
                const { correct, total } = topicAnalysis[label];
                return total > 0 ? (correct / total) * 100 : 0;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: data,
                        backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Topic-wise Performance' } }
                }
            });
        }

        function reviewTest(){document.getElementById("results-modal").classList.remove("show"),document.getElementById("floating-pdf-btn").style.display="flex",showQuestion(0)}
        window.addEventListener('click', e => { if (e.target.classList.contains('results-modal')) e.target.classList.remove('show'); });
        document.addEventListener('keydown', e => { if (e.key === 'ArrowLeft') prevQuestion(); if (e.key === 'ArrowRight') nextQuestion(); });

        // --- PROGRESS SAVING & LOADING ---
        function saveProgress() {
            if (!testStarted || submitted) return;
            let timeLeft = 0;
            const timerDisplay = document.getElementById('timer-display').textContent;
            if (timerDisplay) {
                const parts = timerDisplay.split(':');
                if (parts.length === 2) { timeLeft = parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10); }
            }
            const progress = {
                userName, userMobile, answers, timeLeft, currentQuestion, markedForReview, timeSpent,
                testId: new URLSearchParams(window.location.search).get('test')
            };
            localStorage.setItem('testProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('testProgress');
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                const currentTestId = new URLSearchParams(window.location.search).get('test');
                
                if (progress.testId === currentTestId) {
                    if (confirm("Welcome back! It looks like you have an unfinished test. Do you want to resume?")) {
                        userName = progress.userName || localStorage.getItem('userName') || '';
                        userMobile = progress.userMobile || localStorage.getItem('userMobile') || '';
                        answers = progress.answers || {};
                        markedForReview = progress.markedForReview || {};
                        timeSpent = progress.timeSpent || {};
                        totalTime = progress.timeLeft || totalTime; 
                        
                        testStarted = true;
                        history.pushState({page: 'test'}, 'Test In Progress', '#test');
                        showTestUI();
                        startTimer();
                        window.addEventListener('beforeunload', beforeUnloadHandler);
                        
                        updateProgress();
                        Object.keys(answers).forEach(qId => {
                            const qIndex = questions.findIndex(q => q.id === qId);
                            if (qIndex !== -1) document.getElementById(`box-${qIndex}`).classList.add('attempted');
                        });
                        Object.keys(markedForReview).forEach(qId => {
                             const qIndex = questions.findIndex(q => q.id === qId);
                             if (qIndex !== -1 && markedForReview[qId]) document.getElementById(`box-${qIndex}`).classList.add('marked');
                        });

                        showQuestion(progress.currentQuestion || 0);
                        return true; 
                    } else {
                        localStorage.removeItem('testProgress');
                    }
                } else {
                    localStorage.removeItem('testProgress');
                }
            }
            return false;
        }

        // --- UTILITIES (TELEGRAM & PDF) ---
        async function sendToTelegramLog(e){if(!BOT_TOKEN||!CHAT_ID)return void console.warn("Telegram API credentials are not set. Logging is disabled.");const t=`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;let o="";const n=testTitle,s=new Date().toLocaleString("en-IN",{timeZone:"Asia/Kolkata"});"Test Started"===e.type?o=`🔴 *New Test Started!*\n\n- *User:* \`${e.userName||"N/A"}\`\n- *Mobile:* \`${e.userMobile||"N/A"}\`\n- *Test:* \`${n}\`\n- *Time:* \`${s}\``:"Test Submitted"===e.type&&(o=`✅ *Test Submitted!*\n\n- *User:* \`${e.userName||"N/A"}\`\n- *Mobile:* \`${e.userMobile||"N/A"}\`\n- *Test:* \`${n}\`\n- *Score:* *${e.score}*\n- *Correct:* ${e.correct}\n- *Incorrect:* ${e.incorrect}\n- *Unattempted:* ${e.unattempted}\n- *Time:* \`${s}\``);try{await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:CHAT_ID,text:o,parse_mode:"Markdown"})})}catch(e){console.error("Telegram log failed:",e)}}
                function downloadPDF(e) {
            const btn = e;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                // ... (yahan jsPDF ka poora code waisa hi rahega jaisa pehle tha) ...
                const { jsPDF: o } = window.jspdf;
                const n = new o({ unit: "pt", format: "a4", orientation: "portrait" });
                // ... (poora content drawing ka logic yahan aayega) ...
                let s=40;const a=40,i=n.internal.pageSize.width-2*a,l=()=>{n.addPage(),s=a};n.setFont("Helvetica","bold"),n.setFontSize(18),n.text(`Test Analysis: ${testTitle}`,n.internal.pageSize.width/2,s,{align:"center"}),s+=25,n.setFont("Helvetica","bold"),n.setFontSize(12),n.setTextColor(0,84,166);const d="Developer: Kundan Yadav";n.textWithLink(d,n.internal.pageSize.width/2,s,{url:"https://t.me/kundan_yadav_bot",align:"center"}),n.setFont("Helvetica","normal"),n.setTextColor(0,0,0),s+=25,n.setFontSize(12),n.text(`User: ${userName||"N/A"}`,a,s),s+=15,n.text(`Mobile: ${userMobile||"N/A"}`,a,s),s+=20,n.setLineWidth(1.5),n.line(a,s,n.internal.pageSize.width-a,s),s+=30,n.setFontSize(10);const r=(i-30)/4,c=50;[{label:"Score",value:document.getElementById("score-value").textContent,color:[0,123,255]},{label:"Correct",value:document.getElementById("correct-value").textContent,color:[40,167,69]},{label:"Incorrect",value:document.getElementById("incorrect-value").textContent,color:[220,53,69]},{label:"Unattempted",value:document.getElementById("unattempted-value").textContent,color:[108,117,125]}].forEach((e,t)=>{n.setFillColor(e.color[0],e.color[1],e.color[2]),n.roundedRect(a+t*(r+10),s,r,c,5,5,"F"),n.setTextColor(255,255,255),n.setFont("Helvetica","bold"),n.setFontSize(16),n.text(e.value,a+t*(r+10)+r/2,s+25,{align:"center"}),n.setFont("Helvetica","normal"),n.setFontSize(10),n.text(e.label,a+t*(r+10)+r/2,s+40,{align:"center"})}),s+=c+30;const chartCanvas=document.getElementById("topicAnalysisChart");const chartImage=chartCanvas.toDataURL("image/png",1);n.addImage(chartImage,"PNG",a,s,i,i/2),s+=i/2+30,n.setTextColor(0,0,0),questions.forEach((e,t)=>{s>n.internal.pageSize.height-150&&l(),n.setLineWidth(.5),n.line(a,s,n.internal.pageSize.width-a,s),s+=20,n.setFontSize(11),n.setFont("Helvetica","bold");const o=n.splitTextToSize(`Q${t+1}: ${e.question_en.replace(/\n/g," ")}`,i);n.text(o,a,s),s+=12*o.length+10,n.setFontSize(10),n.setFont("Helvetica","normal");const d=["a","b","c","d"];(e.options_en||[]).forEach((t,o)=>{const i=answers[e.id],l=e.correct,r=d[o];let c=`${String.fromCharCode(65+o)}) ${t}`;r===l?(n.setTextColor(40,167,69),c=(i===r?"✓ ":"  ")+c,n.text(c,a+15,s)):r===i?(n.setTextColor(220,53,69),n.text(`✗ ${c}`,a+15,s)):(n.setTextColor(50,50,50),n.text(`  ${c}`,a+15,s)),s+=15}),n.setTextColor(0,0,0);const c=timeSpent[e.id]||0,m=Math.floor(c/60),u=c%60;let g=answers[e.id]?answers[e.id]===e.correct?"Correct":"Incorrect":"Unattempted";let h=answers[e.id]?answers[e.id]===e.correct?[40,167,69]:[220,53,69]:[108,117,125];n.setFont("Helvetica","bold"),n.setTextColor(h[0],h[1],h[2]),n.text(`Status: ${g}`,a,s),n.setFont("Helvetica","normal"),n.setFontSize(9),n.setTextColor(108,117,125),n.text(`Time Taken: ${m}m ${u}s`,n.internal.pageSize.width-a,s,{align:"right"}),s+=20,n.setFillColor(240,248,255);const f=n.splitTextToSize(`Solution: ${e.solution_en}`,i-20);n.roundedRect(a,s-10,i,12*f.length+15,3,3,"F"),n.setTextColor(50,50,50),n.text(f,a+10,s),s+=12*f.length+15});

                const fileName = `${testTitle} Result by Kundan.pdf`;
                
                // Check if the AndroidApp interface is available (injected by WebView)
                if (window.AndroidApp && typeof window.AndroidApp.savePdf === 'function') {
                    // Get PDF data as a Base64 string
                    const pdfData = n.output('datauristring');
                    // Send the Base64 data and filename to the native Android app
                    window.AndroidApp.savePdf(pdfData, fileName);
                } else {
                    // If not in the app, use the default browser download
                    n.save(fileName);
                }

            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Sorry, there was an error generating the PDF.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>
</html>
